<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Budget Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2193b0;
            --primary-light: #6dd5ed;
            --secondary: #667eea;
            --secondary-dark: #764ba2;
            --success: #56ab2f;
            --success-light: #a8e063;
            --danger: #e73827;
            --danger-light: #f85032;
            --warning: #f39c12;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
            --text: #333;
            --text-light: #666;
            --border: #e0e0e0;
            --shadow: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg: #1a1a2e;
            --card-bg: #16213e;
            --text: #eaeaea;
            --text-light: #b8b8b8;
            --border: #2d3748;
            --shadow: rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text);
            transition: background 0.3s ease;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 20px 60px var(--shadow);
            overflow: hidden;
            transition: background 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .theme-toggle, .settings-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid white;
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s;
        }

        .theme-toggle:hover, .settings-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .currency-selector {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .currency-selector label {
            font-size: 1.1em;
            font-weight: 500;
        }

        .currency-selector select {
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid white;
            background: rgba(255,255,255,0.2);
            color: white;
            font-size: 1em;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }

        .currency-selector select option {
            background: var(--primary);
            color: white;
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            padding: 30px;
        }

        .section {
            background: var(--bg);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px var(--shadow);
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 12px var(--shadow);
        }

        .section h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 3px solid var(--primary-light);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .income-section, .dashboard-section {
            grid-column: 1 / -1;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text);
            font-weight: 500;
        }

        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            background: var(--card-bg);
            color: var(--text);
        }

        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(33,147,176,0.1);
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .category-input-wrapper {
            position: relative;
        }

        .category-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2em;
            pointer-events: none;
        }

        .category-input-wrapper input {
            padding-left: 40px;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33,147,176,0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-light) 0%, var(--danger) 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231,56,39,0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, var(--success-light) 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86,171,47,0.4);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .expense-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            align-items: end;
            margin-bottom: 20px;
        }

        .search-filter {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-filter input, .search-filter select {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--card-bg);
            color: var(--text);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px var(--shadow);
            text-align: center;
            transition: all 0.3s;
            border-left: 4px solid var(--primary);
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 10px var(--shadow);
        }

        .stat-card h3 {
            color: var(--text-light);
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .stat-card .amount {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
        }

        .stat-card.positive {
            border-left-color: var(--success);
        }

        .stat-card.positive .amount {
            color: var(--success);
        }

        .stat-card.negative {
            border-left-color: var(--danger);
        }

        .stat-card.negative .amount {
            color: var(--danger);
        }

        .chart-container {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            position: relative;
            height: 300px;
        }

        .category-breakdown {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .category-item {
            margin-bottom: 20px;
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }

        .progress-bar {
            background: var(--border);
            height: 25px;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success) 0%, var(--success-light) 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.85em;
        }

        .progress-fill.over-budget {
            background: linear-gradient(90deg, var(--danger-light) 0%, var(--danger) 100%);
        }

        .progress-fill.warning {
            background: linear-gradient(90deg, var(--warning) 0%, #f1c40f 100%);
        }

        .expense-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }

        .expense-item {
            background: var(--card-bg);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow);
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }

        .expense-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .expense-item .info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .expense-item .category-badge {
            background: var(--primary);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .expense-item .amount {
            font-weight: bold;
            color: var(--danger);
            font-size: 1.1em;
        }

        .expense-item .date {
            color: var(--text-light);
            font-size: 0.85em;
        }

        .expense-actions {
            display: flex;
            gap: 5px;
        }

        .btn-icon {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 1.1em;
            transition: all 0.3s;
        }

        .btn-edit {
            color: var(--primary);
        }

        .btn-edit:hover {
            background: rgba(33,147,176,0.1);
        }

        .btn-delete {
            color: var(--danger);
        }

        .btn-delete:hover {
            background: rgba(231,56,39,0.1);
        }

        .savings-goal {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .alert-warning {
            background: rgba(243,156,18,0.1);
            border-left: 4px solid var(--warning);
            color: var(--text);
        }

        .alert-danger {
            background: rgba(231,56,39,0.1);
            border-left: 4px solid var(--danger);
            color: var(--text);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .category-grid {
                grid-template-columns: 1fr;
            }

            .expense-form {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .header-controls {
                position: static;
                justify-content: center;
                margin-top: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-controls">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark Mode">üåì</button>
            </div>
            <h1>üí∞ Personal Budget Tracker</h1>
            <p>Take control of your finances with ease</p>
            <div class="currency-selector">
                <label for="currency">Currency:</label>
                <select id="currency" onchange="updateCurrency()">
                    <option value="$">USD ($)</option>
                    <option value="‚Çπ">Indian Rupee (‚Çπ)</option>
                    <option value="‚Ç¨">Euro (‚Ç¨)</option>
                    <option value="¬£">British Pound (¬£)</option>
                    <option value="¬•">Japanese Yen (¬•)</option>
                    <option value="‚Ç©">South Korean Won (‚Ç©)</option>
                    <option value="A$">Australian Dollar (A$)</option>
                    <option value="C$">Canadian Dollar (C$)</option>
                    <option value="CHF">Swiss Franc (CHF)</option>
                    <option value="¬•">Chinese Yuan (¬•)</option>
                </select>
            </div>
        </div>

        <div class="main-content">
            <div class="section income-section">
                <h2>üíµ Monthly Budget Setup</h2>
                <div class="input-group">
                    <label for="income">Total Monthly Income</label>
                    <input type="number" id="income" placeholder="Enter your monthly income" step="0.01" oninput="calculateBudget()">
                </div>
                <div class="category-grid" id="budgetCategories"></div>
            </div>

            <div class="section">
                <h2>üìù Add Expense</h2>
                <div class="expense-form">
                    <div class="input-group">
                        <label for="expenseAmount">Amount</label>
                        <input type="number" id="expenseAmount" placeholder="0.00" step="0.01">
                    </div>
                    <div class="input-group">
                        <label for="expenseCategory">Category</label>
                        <select id="expenseCategory"></select>
                    </div>
                    <div class="input-group">
                        <label for="expenseDate">Date</label>
                        <input type="date" id="expenseDate">
                    </div>
                    <div class="input-group">
                        <label for="expenseDescription">Description</label>
                        <input type="text" id="expenseDescription" placeholder="What was this for?">
                    </div>
                    <button class="btn btn-primary" onclick="addExpense()">‚ûï Add Expense</button>
                </div>
                <div id="expenseAlerts"></div>
            </div>

            <div class="section">
                <h2>üîç Expense History</h2>
                <div class="search-filter">
                    <input type="text" id="searchExpense" placeholder="Search expenses..." oninput="filterExpenses()">
                    <select id="filterCategory" onchange="filterExpenses()">
                        <option value="">All Categories</option>
                    </select>
                    <input type="month" id="filterMonth" onchange="filterExpenses()">
                </div>
                <div class="expense-list" id="expenseList">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No expenses yet. Add your first expense above!</p>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>üéØ Savings Goal Tracker</h2>
                <div class="input-group">
                    <label for="savingsGoal">Savings Goal</label>
                    <input type="number" id="savingsGoal" placeholder="Enter your savings goal" step="0.01" oninput="updateSavingsProgress()">
                </div>
                <div class="input-group">
                    <label for="currentSavings">Current Savings</label>
                    <input type="number" id="currentSavings" placeholder="Current saved amount" step="0.01" oninput="updateSavingsProgress()">
                </div>
                <div class="category-item" style="margin-top: 15px;">
                    <div class="category-header">
                        <span>Progress</span>
                        <span id="savingsPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="savingsProgress" style="width: 0%">0%</div>
                    </div>
                </div>
            </div>

            <div class="section dashboard-section">
                <h2>üìä Dashboard Overview</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Budget</h3>
                        <div class="amount" id="totalBudget">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Spent</h3>
                        <div class="amount" id="totalSpent">$0</div>
                    </div>
                    <div class="stat-card" id="remainingCard">
                        <h3>Remaining</h3>
                        <div class="amount" id="remaining">$0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Expenses</h3>
                        <div class="amount" id="totalExpenses">0</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>

                <div class="category-breakdown">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">Category Breakdown</h3>
                    <div id="categoryBreakdown"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-success" onclick="exportData('txt')">üì• Export as TXT</button>
                    <button class="btn btn-success" onclick="exportData('json')">üì• Export as JSON</button>
                    <button class="btn btn-success" onclick="exportData('csv')">üì• Export as CSV</button>
                    <button class="btn btn-danger" onclick="resetData()">üîÑ Reset Monthly Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Expense Modal -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h2>Edit Expense</h2>
            <div class="input-group">
                <label for="editAmount">Amount</label>
                <input type="number" id="editAmount" step="0.01">
            </div>
            <div class="input-group">
                <label for="editCategory">Category</label>
                <select id="editCategory"></select>
            </div>
            <div class="input-group">
                <label for="editDate">Date</label>
                <input type="date" id="editDate">
            </div>
            <div class="input-group">
                <label for="editDescription">Description</label>
                <input type="text" id="editDescription">
            </div>
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="saveEdit()">üíæ Save Changes</button>
                <button class="btn btn-danger" onclick="closeEditModal()">‚ùå Cancel</button>
            </div>
        </div>
    </div>

    <script>
        let currency = '$';
        const categoryIcons = {
            'Housing': 'üè†',
            'Food': 'üçî',
            'Transportation': 'üöó',
            'Entertainment': 'üé¨',
            'Utilities': 'üí°',
            'Healthcare': 'üè•',
            'Savings': 'üí∞',
            'Other': 'üì¶'
        };
        const categories = Object.keys(categoryIcons);
        let budgets = {};
        let expenses = [];
        let filteredExpenses = [];
        let editingExpenseId = null;
        let categoryChart = null;

        // Set today's date as default
        document.getElementById('expenseDate').valueAsDate = new Date();

        function init() {
            const budgetGrid = document.getElementById('budgetCategories');
            const expenseCategory = document.getElementById('expenseCategory');
            const filterCategory = document.getElementById('filterCategory');
            const editCategory = document.getElementById('editCategory');
            
            categories.forEach(cat => {
                // Budget categories
                const div = document.createElement('div');
                div.className = 'input-group';
                div.innerHTML = `
                    <div class="category-input-wrapper">
                        <span class="category-icon">${categoryIcons[cat]}</span>
                        <label for="budget-${cat}">${cat}</label>
                        <input type="number" id="budget-${cat}" placeholder="Budget amount" step="0.01" oninput="calculateBudget()">
                    </div>
                `;
                budgetGrid.appendChild(div);

                // Expense category dropdown
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = `${categoryIcons[cat]} ${cat}`;
                expenseCategory.appendChild(option);

                // Filter category dropdown
                const filterOption = document.createElement('option');
                filterOption.value = cat;
                filterOption.textContent = cat;
                filterCategory.appendChild(filterOption);

                // Edit category dropdown
                const editOption = document.createElement('option');
                editOption.value = cat;
                editOption.textContent = `${categoryIcons[cat]} ${cat}`;
                editCategory.appendChild(editOption);

                budgets[cat] = 0;
            });

            loadData();
            updateDisplay();
            initChart();
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            if (categoryChart) {
                updateChart();
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        }

        function updateCurrency() {
            currency = document.getElementById('currency').value;
            updateDisplay();
            saveData();
        }

        function calculateBudget() {
            categories.forEach(cat => {
                const input = document.getElementById(`budget-${cat}`);
                budgets[cat] = parseFloat(input.value) || 0;
            });
            saveData();
            updateDisplay();
        }

        function addExpense() {
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const category = document.getElementById('expenseCategory').value;
            const description = document.getElementById('expenseDescription').value;
            const date = document.getElementById('expenseDate').value;

            if (!amount || amount <= 0) {
                showAlert('Please enter a valid amount', 'danger');
                return;
            }
            if (!category) {
                showAlert('Please select a category', 'danger');
                return;
            }
            if (!date) {
                showAlert('Please select a date', 'danger');
                return;
            }

            const expense = {
                id: Date.now(),
                amount: amount,
                category: category,
                description: description || 'No description',
                date: date
            };

            expenses.push(expense);
            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseDescription').value = '';
            document.getElementById('expenseDate').valueAsDate = new Date();
            
            checkBudgetAlerts(category, amount);
            saveData();
            filterExpenses();
            updateDisplay();
            showAlert('Expense added successfully!', 'success');
        }

        function checkBudgetAlerts(category, amount) {
            const budget = budgets[category] || 0;
            const spent = expenses
                .filter(e => e.category === category)
                .reduce((sum, e) => sum + e.amount, 0);
            
            const remaining = budget - spent;
            const percentage = budget > 0 ? (spent / budget * 100) : 0;

            if (percentage > 100) {
                showAlert(`‚ö†Ô∏è You've exceeded the ${category} budget by ${currency}${Math.abs(remaining).toFixed(2)}!`, 'danger');
            } else if (percentage > 80) {
                showAlert(`‚ö†Ô∏è You're approaching your ${category} budget limit (${percentage.toFixed(0)}%)`, 'warning');
            }
        }

        function showAlert(message, type) {
            const alertsContainer = document.getElementById('expenseAlerts');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `<span>${message}</span><button class="btn-icon" onclick="this.parentElement.remove()" style="margin-left: auto;">‚úï</button>`;
            alertsContainer.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function editExpense(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;

            editingExpenseId = id;
            document.getElementById('editAmount').value = expense.amount;
            document.getElementById('editCategory').value = expense.category;
            document.getElementById('editDate').value = expense.date;
            document.getElementById('editDescription').value = expense.description;
            document.getElementById('editModal').classList.add('active');
        }

        function saveEdit() {
            if (editingExpenseId === null) return;

            const expense = expenses.find(e => e.id === editingExpenseId);
            if (!expense) return;

            expense.amount = parseFloat(document.getElementById('editAmount').value);
            expense.category = document.getElementById('editCategory').value;
            expense.date = document.getElementById('editDate').value;
            expense.description = document.getElementById('editDescription').value;

            expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            saveData();
            filterExpenses();
            updateDisplay();
            closeEditModal();
            showAlert('Expense updated successfully!', 'success');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingExpenseId = null;
        }

        function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses = expenses.filter(e => e.id !== id);
                saveData();
                filterExpenses();
                updateDisplay();
                showAlert('Expense deleted successfully!', 'success');
            }
        }

        function filterExpenses() {
            const search = document.getElementById('searchExpense').value.toLowerCase();
            const category = document.getElementById('filterCategory').value;
            const month = document.getElementById('filterMonth').value;

            filteredExpenses = expenses.filter(exp => {
                const matchSearch = !search || 
                    exp.description.toLowerCase().includes(search) ||
                    exp.category.toLowerCase().includes(search);
                const matchCategory = !category || exp.category === category;
                const matchMonth = !month || exp.date.startsWith(month);
                
                return matchSearch && matchCategory && matchMonth;
            });

            updateExpenseList();
        }

        function updateDisplay() {
            const income = parseFloat(document.getElementById('income').value) || 0;
            const totalBudget = Object.values(budgets).reduce((a, b) => a + b, 0);
            const totalSpent = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const remaining = totalBudget - totalSpent;

            document.getElementById('totalBudget').textContent = formatCurrency(totalBudget);
            document.getElementById('totalSpent').textContent = formatCurrency(totalSpent);
            document.getElementById('remaining').textContent = formatCurrency(remaining);
            document.getElementById('totalExpenses').textContent = expenses.length;

            const remainingCard = document.getElementById('remainingCard');
            remainingCard.className = 'stat-card';
            if (remaining >= 0) {
                remainingCard.classList.add('positive');
            } else {
                remainingCard.classList.add('negative');
            }

            updateCategoryBreakdown();
            updateChart();
        }

        function formatCurrency(amount) {
            return currency + amount.toFixed(2);
        }

        function updateCategoryBreakdown() {
            const breakdown = document.getElementById('categoryBreakdown');
            breakdown.innerHTML = '';

            if (Object.values(budgets).every(b => b === 0)) {
                breakdown.innerHTML = '<p style="text-align: center; color: var(--text-light); padding: 20px;">Set your budgets above to see the breakdown</p>';
                return;
            }

            categories.forEach(cat => {
                const budget = budgets[cat] || 0;
                if (budget === 0) return;

                const spent = expenses
                    .filter(e => e.category === cat)
                    .reduce((sum, e) => sum + e.amount, 0);

                const remaining = budget - spent;
                const percentage = (spent / budget * 100);

                const div = document.createElement('div');
                div.className = 'category-item';
                
                let progressClass = '';
                if (percentage > 100) progressClass = 'over-budget';
                else if (percentage > 80) progressClass = 'warning';

                div.innerHTML = `
                    <div class="category-header">
                        <span>${categoryIcons[cat]} ${cat}</span>
                        <span>${formatCurrency(spent)} / ${formatCurrency(budget)} (${formatCurrency(remaining)} ${remaining >= 0 ? 'left' : 'over'})</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${progressClass}" style="width: ${Math.min(percentage, 100)}%">
                            ${percentage.toFixed(0)}%
                        </div>
                    </div>
                `;
                breakdown.appendChild(div);
            });
        }

        function updateExpenseList() {
            const list = document.getElementById('expenseList');
            list.innerHTML = '';

            const displayExpenses = filteredExpenses.length > 0 ? filteredExpenses : expenses;

            if (displayExpenses.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No expenses found. ${expenses.length === 0 ? 'Add your first expense above!' : 'Try adjusting your filters.'}</p>
                    </div>
                `;
                return;
            }

            displayExpenses.forEach(exp => {
                const div = document.createElement('div');
                div.className = 'expense-item';
                const date = new Date(exp.date).toLocaleDateString();
                div.innerHTML = `
                    <div class="info">
                        <span class="category-badge">${categoryIcons[exp.category]} ${exp.category}</span>
                        <span>${exp.description}</span>
                        <span class="date">${date}</span>
                    </div>
                    <span class="amount">${formatCurrency(exp.amount)}</span>
                    <div class="expense-actions">
                        <button class="btn-icon btn-edit" onclick="editExpense(${exp.id})" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-icon btn-delete" onclick="deleteExpense(${exp.id})" title="Delete">‚úï</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        function initChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');
            const theme = document.body.getAttribute('data-theme') || 'light';
            const textColor = theme === 'dark' ? '#eaeaea' : '#333';
            
            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{
                        data: [],
                        backgroundColor: [
                            '#2193b0', '#6dd5ed', '#56ab2f', '#a8e063',
                            '#f85032', '#e73827', '#f39c12', '#f1c40f'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: textColor,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Spending by Category',
                            color: textColor,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (!categoryChart) return;

            const categorySpending = {};
            categories.forEach(cat => {
                categorySpending[cat] = expenses
                    .filter(e => e.category === cat)
                    .reduce((sum, e) => sum + e.amount, 0);
            });

            const labels = [];
            const data = [];
            const colors = [
                '#2193b0', '#6dd5ed', '#56ab2f', '#a8e063',
                '#f85032', '#e73827', '#f39c12', '#f1c40f'
            ];

            Object.keys(categorySpending).forEach((cat, index) => {
                if (categorySpending[cat] > 0) {
                    labels.push(`${categoryIcons[cat]} ${cat}`);
                    data.push(categorySpending[cat]);
                }
            });

            const theme = document.body.getAttribute('data-theme') || 'light';
            const textColor = theme === 'dark' ? '#eaeaea' : '#333';

            categoryChart.data.labels = labels;
            categoryChart.data.datasets[0].data = data;
            categoryChart.options.plugins.legend.labels.color = textColor;
            categoryChart.options.plugins.title.color = textColor;
            categoryChart.update();
        }

        function updateSavingsProgress() {
            const goal = parseFloat(document.getElementById('savingsGoal').value) || 0;
            const current = parseFloat(document.getElementById('currentSavings').value) || 0;
            const percentage = goal > 0 ? (current / goal * 100) : 0;
            
            document.getElementById('savingsPercent').textContent = percentage.toFixed(0) + '%';
            const progressFill = document.getElementById('savingsProgress');
            progressFill.style.width = Math.min(percentage, 100) + '%';
            progressFill.textContent = percentage.toFixed(0) + '%';
            
            progressFill.className = 'progress-fill';
            if (percentage >= 100) {
                progressFill.classList.add('over-budget');
            } else if (percentage > 80) {
                progressFill.classList.add('warning');
            }
            
            saveData();
        }

        function exportData(format) {
            const income = document.getElementById('income').value;
            const totalBudget = Object.values(budgets).reduce((a, b) => a + b, 0);
            const totalSpent = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const savingsGoal = document.getElementById('savingsGoal').value;
            const currentSavings = document.getElementById('currentSavings').value;

            let content, filename, mimeType;

            if (format === 'json') {
                const data = {
                    currency,
                    income,
                    budgets,
                    expenses,
                    savingsGoal,
                    currentSavings,
                    exportDate: new Date().toISOString()
                };
                content = JSON.stringify(data, null, 2);
                filename = `budget-data-${new Date().toISOString().split('T')[0]}.json`;
                mimeType = 'application/json';
            } else if (format === 'csv') {
                let csv = 'Date,Category,Description,Amount\n';
                expenses.forEach(exp => {
                    csv += `${exp.date},"${exp.category}","${exp.description}",${exp.amount}\n`;
                });
                content = csv;
                filename = `budget-expenses-${new Date().toISOString().split('T')[0]}.csv`;
                mimeType = 'text/csv';
            } else {
                let report = `PERSONAL BUDGET TRACKER SUMMARY\n`;
                report += `================================\n\n`;
                report += `Currency: ${currency}\n`;
                report += `Export Date: ${new Date().toLocaleString()}\n\n`;
                report += `INCOME & BUDGET\n`;
                report += `---------------\n`;
                report += `Monthly Income: ${formatCurrency(income)}\n`;
                report += `Total Budget: ${formatCurrency(totalBudget)}\n`;
                report += `Total Spent: ${formatCurrency(totalSpent)}\n`;
                report += `Remaining: ${formatCurrency(totalBudget - totalSpent)}\n\n`;
                report += `SAVINGS\n`;
                report += `-------\n`;
                report += `Goal: ${formatCurrency(savingsGoal)}\n`;
                report += `Current: ${formatCurrency(currentSavings)}\n`;
                if (savingsGoal > 0) {
                    const progress = (currentSavings / savingsGoal * 100).toFixed(0);
                    report += `Progress: ${progress}%\n`;
                }
                report += `\nCATEGORY BREAKDOWN\n`;
                report += `------------------\n`;
                categories.forEach(cat => {
                    const budget = budgets[cat] || 0;
                    if (budget > 0) {
                        const spent = expenses.filter(e => e.category === cat).reduce((sum, e) => sum + e.amount, 0);
                        report += `${cat}: ${formatCurrency(spent)} / ${formatCurrency(budget)} (${((spent/budget)*100).toFixed(0)}%)\n`;
                    }
                });
                report += `\nEXPENSES (${expenses.length} total)\n`;
                report += `---------\n`;
                expenses.forEach(exp => {
                    const date = new Date(exp.date).toLocaleDateString();
                    report += `${date} | ${exp.category} | ${exp.description} | ${formatCurrency(exp.amount)}\n`;
                });
                content = report;
                filename = `budget-summary-${new Date().toISOString().split('T')[0]}.txt`;
                mimeType = 'text/plain';
            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function resetData() {
            if (confirm('Are you sure you want to reset all data? This action cannot be undone.')) {
                expenses = [];
                categories.forEach(cat => {
                    document.getElementById(`budget-${cat}`).value = '';
                    budgets[cat] = 0;
                });
                document.getElementById('income').value = '';
                document.getElementById('savingsGoal').value = '';
                document.getElementById('currentSavings').value = '';
                document.getElementById('searchExpense').value = '';
                document.getElementById('filterCategory').value = '';
                document.getElementById('filterMonth').value = '';
                filteredExpenses = [];
                saveData();
                updateDisplay();
                filterExpenses();
                updateSavingsProgress();
                showAlert('All data has been reset!', 'success');
            }
        }

        function saveData() {
            const data = {
                currency: currency,
                income: document.getElementById('income').value,
                budgets: budgets,
                expenses: expenses,
                savingsGoal: document.getElementById('savingsGoal').value,
                currentSavings: document.getElementById('currentSavings').value
            };
            localStorage.setItem('budgetTrackerData', JSON.stringify(data));
        }

        function loadData() {
            const saved = localStorage.getItem('budgetTrackerData');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    currency = data.currency || '$';
                    document.getElementById('currency').value = currency;
                    document.getElementById('income').value = data.income || '';
                    budgets = data.budgets || {};
                    expenses = data.expenses || [];
                    
                    // Ensure expenses are sorted by date
                    expenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    categories.forEach(cat => {
                        if (budgets[cat]) {
                            const input = document.getElementById(`budget-${cat}`);
                            if (input) input.value = budgets[cat];
                        }
                    });
                    
                    document.getElementById('savingsGoal').value = data.savingsGoal || '';
                    document.getElementById('currentSavings').value = data.currentSavings || '';
                    updateSavingsProgress();
                    filterExpenses();
                } catch (e) {
                    console.error('Error loading data:', e);
                }
            }
        }

        // Initialize
        loadTheme();
        init();

        // Close modal on outside click
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
    </script>
</body>
</html>